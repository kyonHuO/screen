<!-- Mark 4 -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>S.L.O.T.H. â€“ è£½å“æ¯”è¼ƒãƒ„ãƒ¼ãƒ« (MarkÂ 4)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{font-family:'Noto Sans JP',sans-serif;background:#f8f9fa}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);transition:.3s;cursor:pointer}
    .card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.1)}
    .btn{border-radius:8px;font-weight:600;transition:.2s;padding:0.45rem 0.9rem;font-size:0.8rem}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#6b7280;color:#fff}.btn-secondary:hover{background:#4b5563}
    .btn-tertiary{background:#10b981;color:#fff}.btn-tertiary:hover{background:#059669}
    .btn-danger{background:#ef4444;color:#fff}.btn-danger:hover{background:#dc2626}
    @keyframes fade{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
    .ani{animation:fade .15s ease-out}
    ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-thumb{background:#a8a8a8;border-radius:4px}
  </style>
</head>
<body class="antialiased text-gray-800 select-none">
  <header class="py-4 text-center bg-white shadow fixed top-0 w-full z-40">
    <h1 class="text-3xl font-extrabold tracking-widest text-blue-700">S.L.O.T.H.</h1>
    <p class="text-xs text-gray-500 mt-1">SystemÂ LazilyÂ OptimizedÂ toÂ Help</p>
  </header>

  <!-- ã‚«ãƒ†ã‚´ãƒªé¸æŠ -->
  <div id="screen-select" class="flex flex-col items-center justify-center min-h-screen pt-32 p-6 text-center">
    <h2 class="text-4xl font-extrabold text-blue-700 mb-1">S.L.O.T.H.</h2>
    <p class="text-sm text-gray-500 mb-8">Smart Comparison & Rating Engine â€“ MarkÂ 4</p>
    <p class="mb-10 text-gray-600">æ¯”è¼ƒã—ãŸã„ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</p>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-4xl">
      <button data-cat="tv"  class="card p-8 focus:outline-none cat-btn"><div class="text-5xl mb-4">ğŸ“º</div><span class="text-xl font-semibold">ãƒ†ãƒ¬ãƒ“</span></button>
      <button data-cat="ac"  class="card p-8 focus:outline-none cat-btn"><div class="text-5xl mb-4">ğŸ’¨</div><span class="text-xl font-semibold">ã‚¨ã‚¢ã‚³ãƒ³</span></button>
      <button data-cat="ref" class="card p-8 focus:outline-none cat-btn"><div class="text-5xl mb-4">ğŸ§Š</div><span class="text-xl font-semibold">å†·è”µåº«</span></button>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
  <div id="screen-app" class="hidden container mx-auto p-6 pt-32">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
      <div class="flex gap-2 items-center">
        <button id="btn-back" class="btn bg-gray-200 text-gray-700">&larr; æˆ»ã‚‹</button>
        <label class="flex items-center text-sm font-medium gap-1"><input type="checkbox" id="chk-edit" class="accent-blue-600"> ç·¨é›†ãƒ¢ãƒ¼ãƒ‰</label>
        <button id="btn-add" class="btn btn-primary hidden">ï¼‹ æ–°è¦è¿½åŠ </button>
      </div>
      <div>
        <h2 id="hdg-title" class="text-2xl font-bold"></h2>
        <p id="hdg-sub" class="text-gray-500 text-sm"></p>
      </div>
      <div id="sortbox" class="hidden">
        <label class="text-sm font-semibold mr-1">ä¸¦ã¹æ›¿ãˆ:</label>
        <select id="sel-sort" class="border rounded px-2 py-1 text-sm">
          <option value="maker">ãƒ¡ãƒ¼ã‚«ãƒ¼</option>
          <option value="flag">å±•ç¤º/ã‚¼ãƒ­ã‚¨ãƒŸ</option>
          <option value="size">ã‚µã‚¤ã‚º</option>
        </select>
      </div>
    </div>
    <div id="cmp"></div>
    <div id="filter" class="space-y-6 mb-8"></div>
    <div id="list" class="grid gap-6"></div>
  </div>

  <div id="modal-root"></div>

  <script>
  /* ============== å®šæ•° & è¨­å®š ============== */
  const API_KEY = "AIzaSyDeGpivxKckNctsSKow4GUN4h2z0lw0aSg";
  const cfgs = {
    tv : { file:'tv-data.json',  key:'ãƒ¢ãƒ‡ãƒ«å', flag:'å±•ç¤ºå“',       flagLabel:'å±•ç¤ºå“', size:'ã‚µã‚¤ã‚º(ã‚¤ãƒ³ãƒ)', title:'ãƒ†ãƒ¬ãƒ“æ¯”è¼ƒ',   subtitle:'ãƒ†ãƒ¬ãƒ“ã‚’é¸æŠã—ã¦æ¯”è¼ƒ',   filters:['ãƒ¡ãƒ¼ã‚«ãƒ¼','å±•ç¤ºå“'] },
    ac : { file:'ac-data.json',  key:'å‹ç•ª',   flag:'ã‚¼ãƒ­ã‚¨ãƒŸ.æœ‰ç„¡', flagLabel:'ã‚¼ãƒ­ã‚¨ãƒŸ', size:'ç•³æ•°',         title:'ã‚¨ã‚¢ã‚³ãƒ³æ¯”è¼ƒ', subtitle:'ã‚¨ã‚¢ã‚³ãƒ³ã‚’é¸æŠã—ã¦æ¯”è¼ƒ', filters:['ãƒ¡ãƒ¼ã‚«ãƒ¼','ã‚¼ãƒ­ã‚¨ãƒŸ.æœ‰ç„¡'] },
    ref: { file:'refrigerator-data.json', key:'å‹ç•ª', flag:'å±•ç¤ºå“æœ‰ç„¡', flagLabel:'å±•ç¤ºå“', size:'å®¹é‡(L)',     title:'å†·è”µåº«æ¯”è¼ƒ', subtitle:'å†·è”µåº«ã‚’é¸æŠã—ã¦æ¯”è¼ƒ',   filters:['ãƒ¡ãƒ¼ã‚«ãƒ¼','å±•ç¤ºå“æœ‰ç„¡'] }
  };
  const S = { cat:null, data:[], sel:[], flt:{}, edit:false };
  const $  = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);

  /* ============== åˆæœŸåŒ– ============== */
  document.addEventListener('DOMContentLoaded', () => {
    $$('.cat-btn').forEach(btn => btn.addEventListener('click', () => load(btn.dataset.cat)));
    $('#btn-back').addEventListener('click', () => { $('#screen-select').classList.remove('hidden'); $('#screen-app').classList.add('hidden'); });
    $('#chk-edit').addEventListener('change', e => { S.edit = e.target.checked; $('#btn-add').classList.toggle('hidden', !S.edit); render(); });
    $('#sel-sort').addEventListener('change', render);
    $('#btn-add').addEventListener('click', () => openEditor());
  });

  /* ============== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨ç”»é¢åˆ‡æ›¿ ============== */
  async function load(cat){
    Object.assign(S,{cat,sel:[],flt:{},edit:false});
    $('#chk-edit').checked = false; $('#btn-add').classList.add('hidden');
    const cfg = cfgs[cat];
    $('#hdg-title').textContent = cfg.title + ' (MarkÂ 4)';
    $('#hdg-sub').textContent   = cfg.subtitle;
    $('#sortbox').classList.remove('hidden');

    // v4 FIX: JSON ãŒå–å¾—ã§ããªã„å ´åˆã¯ localStorage ã‹ã‚‰å¾©æ—§
    let data = [];
    try {
      const res = await fetch(cfg.file);
      if(res.ok){
        data = await res.json();
      } else {
        throw new Error(res.status);
      }
    } catch(err){
      const saved = localStorage.getItem(cfg.file);
      if(saved){
        data = JSON.parse(saved);
        console.warn('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹ã‚‰å–å¾—ã§ããªã‹ã£ãŸãŸã‚ localStorage ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™', err);
      } else {
        console.warn('ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŸã‚ç©ºãƒ‡ãƒ¼ã‚¿ã§èµ·å‹•ã—ã¾ã™', err);
      }
    }
    S.data = data;

    $('#screen-select').classList.add('hidden');
    $('#screen-app').classList.remove('hidden');
    render();
  }

  /* ============== æç”»é–¢æ•°ç¾¤ ============== */
  function render(){ renderFilters(); renderList(); renderCompare(); }

  function renderFilters(){
    const cfg = cfgs[S.cat];
    const box = $('#filter'); box.innerHTML = '';
    cfg.filters.forEach(k => {
      const vals = [...new Set(S.data.map(d => getField(d,k)).filter(Boolean))];
      const sec = document.createElement('div');
      sec.innerHTML = `<h4 class='font-bold mb-1 text-sm'>${k}</h4>`;
      const wrap = document.createElement('div'); wrap.className = 'flex flex-wrap gap-2';
      wrap.appendChild(fbtn(k,null,'ã™ã¹ã¦'));
      vals.forEach(v => wrap.appendChild(fbtn(k,v,v)));
      sec.appendChild(wrap); box.appendChild(sec);
    });
  }
  function fbtn(key,val,label){
    const b = document.createElement('button'); b.className='btn bg-gray-200 text-gray-700 text-xs';
    if((val===null && !S.flt[key]) || S.flt[key]===val) b.classList.add('btn-primary','text-white');
    b.textContent = label;
    b.onclick = () => { val===null ? delete S.flt[key] : S.flt[key]=val; render(); };
    return b;
  }

  function renderList(){
    const cfg = cfgs[S.cat];
    let list = [...S.data];
    for(const [k,v] of Object.entries(S.flt)) list = list.filter(d=>getField(d,k)==v);
    const sKey = $('#sel-sort').value;
    list.sort((a,b) => {
      if(sKey==='maker') return (a['ãƒ¡ãƒ¼ã‚«ãƒ¼']||'').localeCompare(b['ãƒ¡ãƒ¼ã‚«ãƒ¼']||'');
      if(sKey==='flag')  return (isFlag(a,cfg)===isFlag(b,cfg))?0:(isFlag(a,cfg)?-1:1);
      const av=parseFloat(a[cfg.size])||0, bv=parseFloat(b[cfg.size])||0; return av-bv;
    });
    const wrap = $('#list'); wrap.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';
    wrap.innerHTML = list.map(d=>card(d,cfg)).join('');
    $$('#list .card-root').forEach(el => el.addEventListener('click', e => { if(!e.target.closest('button')) openDetail(list.find(x=>x.id===el.dataset.id),cfg);}));
  }
  function card(d,cfg){ d.id = d.id || crypto.randomUUID(); const sel=S.sel.includes(d.id);
    return `<div class='card p-4 flex flex-col gap-2 card-root' data-id='${d.id}'>
      <div class='flex justify-between items-start'><h4 class='font-semibold text-xs sm:text-sm'>${d[cfg.key]}</h4>${isFlag(d,cfg)?`<span class='text-xs px-2 py-0.5 bg-yellow-400 rounded'>${cfg.flagLabel}</span>`:''}</div>
      <div class='text-xs space-y-1'>${['ãƒ¡ãƒ¼ã‚«ãƒ¼',cfg.size,cfg.flagLabel].map(k=>`<p><span class='font-medium'>${k}:</span> ${getField(d,k)??'-'}</p>`).join('')}</div>
      <div class='mt-auto grid grid-cols-4 gap-1 text-xs'>
        <button class='btn btn-primary col-span-2' onclick='event.stopPropagation();toggleSel("${d.id}")'>${sel?'è§£é™¤':'æ¯”è¼ƒ'}</button>
        <button class='btn btn-secondary' onclick='event.stopPropagation();window.open("https://www.google.com/search?q=${encodeURIComponent(d[cfg.key])}")'>ğŸ”</button>
        <button class='btn btn-tertiary' onclick='event.stopPropagation();askGemini("${d[cfg.key]}")'>G</button>
      </div>
      ${S.edit?`<button class='btn btn-danger mt-1' onclick='event.stopPropagation();openEditor("${d.id}")'>ç·¨é›†</button>`:''}
    </div>`;
  }

  /* ============== æ¯”è¼ƒãƒ‘ãƒãƒ« ============== */
  function toggleSel(id){ S.sel = S.sel.includes(id)? S.sel.filter(x=>x!==id) : (S.sel.length<6?[...S.sel,id]:S.sel); renderCompare(); renderList(); }
  function renderCompare(){
    const box = $('#cmp'); if(!S.sel.length){ box.innerHTML=''; return; }
    const cfg = cfgs[S.cat]; const items = S.data.filter(d=>S.sel.includes(d.id));
    const head = items.map(i=>`<th class='px-2 py-1'>${i[cfg.key]}<button class='ml-1 text-red-600' onclick='toggleSel("${i.id}")'>Ã—</button></th>`).join('');
    const rows = ['ãƒ¡ãƒ¼ã‚«ãƒ¼',cfg.size,cfg.flagLabel].map(k=>`<tr><td class='font-medium pr-2 text-xs'>${k}</td>${items.map(i=>`<td class='px-2 py-1 text-xs'>${getField(i,k)??'-'}</td>`).join('')}</tr>`).join('');
    box.innerHTML = `<div class='card p-4 mb-4 ani'><div class='flex justify-between mb-2'><strong>æ¯”è¼ƒ (${items.length}/6)</strong><div class='flex gap-2'><button class='btn btn-secondary' onclick='openBig(${JSON.stringify(items.map(x=>x.id))})'>å…¨ç”»é¢</button><button class='btn btn-tertiary' onclick='askGemini("${items.map(i=>i[cfg.key]).join(', ')} ã‚’æ¯”è¼ƒã—ã¦ç‰¹å¾´ã¾ã¨ã‚ã¦")'>G</button></div></div><table class='min-w-max text-xs border-collapse'><thead><tr><th></th>${head}</tr></thead><tbody>${rows}</tbody></table></div>`;
  }
  function openBig(ids){ const items=S.data.filter(d=>ids.includes(d.id)), cfg=cfgs[S.cat]; const keys=[...new Set(items.flatMap(allKeys))];
    const head=items.map(i=>`<th class='px-2 py-1 text-left'>${i[cfg.key]}</th>`).join('');
    const body=keys.map(k=>`<tr><td class='font-medium pr-2 align-top text-xs'>${k}</td>${items.map(i=>`<td class='px-2 py-1 text-xs'>${JSON.stringify(getField(i,k)??'-')}</td>`).join('')}</tr>`).join('');
    modal(`<div class='bg-white rounded-xl w-[95vw] h-[90vh] p-4 flex flex-col'><div class='flex justify-between items-center mb-2'><h3 class='text-lg font-bold'>ãƒ•ãƒ«æ¯”è¼ƒ</h3><button class='text-xl' id='md-close'>Ã—</button></div><div class='overflow-auto border rounded grow'><table class='min-w-max text-xs border-collapse'><thead class='sticky top-0 bg-white shadow'><tr><th></th>${head}</tr></thead><tbody>${body}</tbody></table></div></div>`);
  }

  /* ============== ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š ============== */
  function modal(html){ const r=$('#modal-root'); r.innerHTML = `<div class='fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50' id='md-bg'><div class='ani'>${html}</div></div>`; $('#md-bg').addEventListener('click', e=>{ if(e.target.id==='md-bg' || e.target.id==='md-close') r.innerHTML=''; }); }

  /* ============== è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« ============== */
  function openDetail(d,cfg){ const keys=allKeys(d); modal(`<div class='bg-white rounded-xl max-w-lg w-full p-6'><h3 class='text-lg font-bold mb-4'>${d[cfg.key]}</h3><div class='space-y-1 text-xs max-h-[70vh] overflow-auto'>${keys.map(k=>`<p><span class='font-medium'>${k}</span>: ${JSON.stringify(getField(d,k))}</p>`).join('')}</div><button class='btn btn-primary mt-4' id='md-close'>é–‰ã˜ã‚‹</button></div>`); }

  /* ============== ã‚¨ãƒ‡ã‚£ã‚¿ ============== */
  function openEditor(id){ const cfg=cfgs[S.cat]; const d=id?structuredClone(S.data.find(x=>x.id===id)):{id:crypto.randomUUID()}; const newItem=!id; const spec={å±•ç¤ºå“:['ã‚ã‚Š','ãªã—'],å±•ç¤ºå“æœ‰ç„¡:['ã‚ã‚Š','ãªã—'],'ã‚¼ãƒ­ã‚¨ãƒŸ.æœ‰ç„¡':['ã‚ã‚Š','ãªã—']};
    const keys=newItem?Object.keys(S.data[0]||{}):allKeys(d);
    const rows=keys.map(k=>{ const v=getField(d,k)??''; const sel=spec[k]!=undefined; const opts=sel?spec[k].map(o=>`<option ${o===v?'selected':''}>${o}</option>`).join(''):''; return `<div><label class='text-xs font-medium'>${k}</label>${sel?`<select class='border rounded w-full p-1 text-xs' name='${k}'>${opts}</select>`:`<input class='border rounded w-full p-1 text-xs' name='${k}' value='${v}'>`}</div>` }).join('');
    modal(`<div class='bg-white rounded-xl w-full max-w-lg p-6 flex flex-col'><h3 class='text-lg font-bold mb-4'>${newItem?'æ–°è¦':'ç·¨é›†'}</h3><form id='f-edit' class='grid grid-cols-2 gap-2 overflow-auto max-h-[60vh]'>${rows}</form><div class='flex justify-end gap-2 mt-4'><button class='btn btn-secondary' id='md-close'>ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button><button class='btn btn-primary' id='md-save'>ä¿å­˜</button></div></div>`);
    $('#md-save').addEventListener('click',()=>{ const fd=new FormData($('#f-edit')); keys.forEach(k=>setField(d,k,fd.get(k))); if(newItem) S.data.push(d); localStorage.setItem(cfg.file, JSON.stringify(S.data)); $('#modal-root').innerHTML=''; render(); }); }

  /* ============== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ============== */
  function allKeys(o){ return typeof o==='object'&&o!==null?Object.entries(o).flatMap(([k,v])=> typeof v==='object'&&v!==null?Object.keys(v).map(s=>`${k}.${s}`):[k]):[]; }
  function getField(o,k){ if(k.includes('.')){ const[a,b]=k.split('.'); return o[a]?.[b]; } return o[k]; }
  function setField(o,k,v){ if(k.includes('.')){ const[a,b]=k.split('.'); o[a]=o[a]||{}; o[a][b]=v; } else o[k]=v; }
  function isFlag(o,cfg){ const val=getField(o,cfg.flag); return val==='ã‚ã‚Š' || val===true || val==='Yes'; }
  /* ============================================ */
  </script>
</body>
</html>
