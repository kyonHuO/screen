<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>S.L.O.T.H. – 製品比較ツール</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
 body{font-family:'Noto Sans JP',sans-serif;background:#f8f9fa}
 .card{background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);transition:.3s;cursor:pointer}
 .card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.1)}
 .btn{border-radius:8px;font-weight:600;transition:.2s;padding:0.45rem 0.9rem;font-size:0.8rem}
 .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
 .btn-secondary{background:#6b7280;color:#fff}.btn-secondary:hover{background:#4b5563}
 .btn-tertiary{background:#10b981;color:#fff}.btn-tertiary:hover{background:#059669}
 .btn-danger{background:#ef4444;color:#fff}.btn-danger:hover{background:#dc2626}
 @keyframes fade{from{opacity:0;transform:scale(.97)}to{opacity:1;transform:scale(1)}}
 .ani{animation:fade .15s ease-out}
 ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-thumb{background:#a8a8a8;border-radius:4px}
</style>
</head>
<body class="antialiased text-gray-800 select-none">
<header class="py-4 text-center bg-white shadow fixed top-0 w-full z-40">
 <h1 class="text-3xl font-extrabold tracking-widest text-blue-700">S.L.O.T.H.</h1>
 <p class="text-xs text-gray-500 mt-1">System Lazily Optimized to Help</p>
</header>

<!-- カテゴリ選択 -->
<div id="sel" class="flex flex-col items-center justify-center min-h-screen pt-32 p-6 text-center">
 <h2 class="text-4xl font-extrabold text-blue-700 mb-1">S.L.O.T.H.</h2>
 <p class="text-sm text-gray-500 mb-8">System Lazily Optimized to Help</p>
 <p class="mb-10 text-gray-600">比較したいカテゴリを選択</p>
 <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-4xl">
  <div id="go-tv"  class="card p-8"><div class="text-5xl mb-4">📺</div><span class="text-xl font-semibold">テレビ</span></div>
  <div id="go-ac"  class="card p-8"><div class="text-5xl mb-4">💨</div><span class="text-xl font-semibold">エアコン</span></div>
  <div id="go-ref" class="card p-8"><div class="text-5xl mb-4">🧊</div><span class="text-xl font-semibold">冷蔵庫</span></div>
 </div>
</div>

<!-- メイン -->
<div id="app" class="hidden container mx-auto p-6 pt-32">
 <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4">
  <div class="flex gap-2 items-center">
   <button id="btn-back" class="btn bg-gray-200 text-gray-700">&larr; 戻る</button>
   <label class="flex items-center text-sm font-medium gap-1"><input type="checkbox" id="chk-edit" class="accent-blue-600"> 編集モード</label>
   <button id="btn-add" class="btn btn-primary hidden">＋ 新規追加</button>
  </div>
  <div>
   <h2 id="ttl" class="text-2xl font-bold"></h2>
   <p id="sub" class="text-gray-500 text-sm"></p>
  </div>
  <div id="sortbox" class="hidden"><label class="text-sm font-semibold mr-1">並べ替え:</label><select id="sel-sort" class="border rounded px-2 py-1 text-sm"><option value="maker">メーカー</option><option value="flag">展示品/ゼロエミ</option><option value="size">サイズ</option></select></div>
 </div>

 <!-- 比較プレビュー -->
 <div id="cmp"></div>
 <!-- フィルタ -->
 <div id="filter" class="space-y-6 mb-8"></div>
 <!-- カードリスト -->
 <div id="list" class="grid gap-6"></div>
</div>

<div id="root-modal"></div>

<script>
const KEY="AIzaSyDeGpivxKckNctsSKow4GUN4h2z0lw0aSg";
const cfgs={
 tv :{file:'tv-data.json', key:'モデル名', flag:'展示品', flagLabel:'展示品', size:'サイズ(インチ)', title:'テレビ比較', subtitle:'テレビを選択して比較', filters:['メーカー','展示品']},
 ref:{file:'refrigerator-data.json', key:'型番', flag:'展示品有無', flagLabel:'展示品', size:'容量(L)', title:'冷蔵庫比較', subtitle:'冷蔵庫を選択して比較', filters:['メーカー','展示品有無']},
 ac :{file:'ac-data.json', key:'型番', flag:'ゼロエミ.有無', flagLabel:'ゼロエミ', size:'畳数', title:'エアコン比較', subtitle:'エアコンを選択して比較', filters:['メーカー','ゼロエミ.有無']}
};
const S={cat:null,data:[],sel:[],flt:{},edit:false};
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);

$('#go-tv').onclick=()=>load('tv');$('#go-ac').onclick=()=>load('ac');$('#go-ref').onclick=()=>load('ref');
$('#btn-back').onclick=()=>{$('#sel').classList.remove('hidden');$('#app').classList.add('hidden');};
$('#chk-edit').onchange=e=>{S.edit=e.target.checked;$('#btn-add').classList.toggle('hidden',!S.edit);render();};
$('#sel-sort').onchange=render;$('#btn-add').onclick=()=>openEditor();

async function load(cat){Object.assign(S,{cat,sel:[],flt:{},edit:false});$('#chk-edit').checked=false;$('#btn-add').classList.add('hidden');const c=cfgs[cat];$('#ttl').textContent=c.title;$('#sub').textContent=c.subtitle;$('#sortbox').classList.remove('hidden');try{const r=await fetch(c.file);if(!r.ok)throw r.status;S.data=await r.json();}catch(e){alert('読み込み失敗:'+e);return;}$('#sel').classList.add('hidden');$('#app').classList.remove('hidden');render();}

function render(){renderFilters();renderCards();renderCompare();}

function renderFilters(){const c=cfgs[S.cat];const w=$('#filter');w.innerHTML='';c.filters.forEach(k=>{const vals=[...new Set(S.data.map(d=>getField(d,k)).filter(Boolean))];const sec=document.createElement('div');sec.innerHTML=`<h4 class='font-bold mb-1 text-sm'>${k}</h4>`;const box=document.createElement('div');box.className='flex flex-wrap gap-2';box.appendChild(fbtn(k,null,'すべて'));vals.forEach(v=>box.appendChild(fbtn(k,v,v)));sec.appendChild(box);w.appendChild(sec);});}
const fbtn=(k,v,l)=>{const b=document.createElement('button');b.className='btn bg-gray-200 text-gray-700 text-xs';if((v===null&&!S.flt[k])||S.flt[k]===v)b.classList.add('btn-primary','text-white');b.textContent=l;b.onclick=()=>{v===null?delete S.flt[k]:S.flt[k]=v;render();};return b};

function renderCards(){const c=cfgs[S.cat];let list=[...S.data];Object.entries(S.flt).forEach(([k,v])=>list=list.filter(d=>getField(d,k)==v));const sort=$('#sel-sort').value;list.sort((a,b)=>{if(sort==='maker')return a['メーカー'].localeCompare(b['メーカー']);if(sort==='flag')return (isFlag(a,c)==isFlag(b,c)?0:(isFlag(a,c)?-1:1));return parseFloat(a[c.size])-parseFloat(b[c.size]);});const w=$('#list');w.className='grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6';w.innerHTML=list.map(d=>card(d,c)).join('');$$('#list .c-root').forEach(el=>el.onclick=e=>{if(e.target.closest('button'))return;openDetail(list.find(x=>x.id===el.dataset.id),c);});}
function card(d,c){d.id=d.id||crypto.randomUUID();const sel=S.sel.includes(d.id);return `<div class='card p-4 flex flex-col gap-2 c-root' data-id='${d.id}'>
 <div class='flex justify-between items-start'><h4 class='font-semibold text-sm sm:text-base'>${d[c.key]}</h4>${isFlag(d,c)?`<span class='text-xs px-2 py-0.5 bg-yellow-400 rounded'>${c.flagLabel}</span>`:''}</div>
 <div class='text-xs space-y-1'>${['メーカー',c.size,c.flagLabel].map(k=>`<p><span class='font-medium'>${k}:</span> ${getField(d,k)}</p>`).join('')}</div>
 <div class='mt-auto grid grid-cols-4 gap-1 text-xs'>
  <button class='btn btn-primary col-span-2' onclick='toggleSel("${d.id}")'>${sel?'解除':'比較'}</button>
  <button class='btn btn-secondary' onclick='window.open("https://www.google.com/search?q=${encodeURIComponent(d[c.key])}")'>🔍</button>
  <button class='btn btn-tertiary' onclick='askGemini("${d[c.key]}")'>G</button>
 </div>
 ${S.edit?`<button class='btn btn-danger mt-1' onclick='openEditor("${d.id}")'>編集</button>`:''}
</div>`;}

function toggleSel(id){S.sel=S.sel.includes(id)?S.sel.filter(x=>x!==id):(S.sel.length<6?[...S.sel,id]:S.sel);renderCompare();renderCards();}

function renderCompare(){const c=$('#cmp');if(!S.sel.length){c.innerHTML='';return;}const cfg=cfgs[S.cat],items=S.data.filter(d=>S.sel.includes(d.id));const head=items.map(i=>`<th class='px-2 py-1'>${i[cfg.key]}<button class='ml-1 text-red-600' onclick='toggleSel("${i.id}")'>×</button></th>`).join('');const rows=[...'メーカー',cfg.size,cfg.flagLabel].map(k=>`<tr><td class='font-medium pr-2 text-xs'>${k}</td>${items.map(i=>`<td class='px-2 py-1 text-xs'>${getField(i,k)||'-'}</td>`).join('')}</tr>`).join('');c.innerHTML=`<div class='card p-4 mb-4 ani'><div class='flex justify-between mb-2'><div><strong>比較 (${items.length}/6)</strong></div><div class='flex gap-2'><button class='btn btn-secondary' onclick='openBig(${JSON.stringify(items.map(x=>x.id))})'>全画面</button><button class='btn btn-tertiary' onclick='askGemini("${items.map(i=>i[cfg.key]).join(', ')} を比較して特徴まとめて")'>Gemini</button></div></div><table class='min-w-max text-xs border-collapse'><thead><tr><th></th>${head}</tr></thead><tbody>${rows}</tbody></table></div>`;}

function openBig(ids){const items=S.data.filter(d=>ids.includes(d.id));const keys=getAllKeys(items);const cfg=cfgs[S.cat];const head=items.map(i=>`<th class='px-2 py-2 text-left'>${i[cfg.key]}</th>`).join('');const body=keys.map(k=>`<tr><td class='font-medium pr-2 align-top text-sm'>${k}</td>${items.map(i=>`<td class='px-2 py-1 text-sm'>${JSON.stringify(getField(i,k)??'-')}</td>`).join('')}</tr>`).join('');const r=$('#root-modal');r.innerHTML=`<div class='fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50' id='big-bg'><div class='bg-white rounded-xl w-[95vw] h-[90vh] p-4 flex flex-col ani'><div class='flex justify-between items-center mb-2'><h3 class='text-xl font-bold'>フル比較 (${items.length}件)</h3><button class='text-xl' id='close-big'>×</button></div><div class='overflow-auto border rounded grow'><table class='min-w-max text-xs sm:text-sm border-collapse table-auto'><thead class='sticky top-0 bg-white shadow'><tr><th></th>${head}</tr></thead><tbody>${body}</tbody></table></div></div></div>`;$('#close-big').onclick=$('#big-bg').onclick=e=>{if(e.target.id==='big-bg'||e.target.id==='close-big')r.innerHTML=''};}

function getAllKeys(arr){return [...new Set(arr.flatMap(o=>Object.keys(o).concat(Object.entries(o).filter(([_,v])=>typeof v==='object'&&v!==null).flatMap(([k,v])=>Object.keys(v).map(s=>`${k}.${s}`))))];}

function openDetail(d,c){const r=$('#root-modal');r.innerHTML=`<div class='fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50' id='det-bg'><div class='bg-white rounded-2xl max-w-lg w-full p-6 relative ani'><button class='absolute top-3 right-3 text-xl' id='close-det'>×</button><h3 class='text-xl font-bold mb-4'>${d[c.key]}</h3><div class='space-y-1 text-sm max-h-[70vh] overflow-auto'>${getAllKeys([d]).map(k=>`<p><span class='font-medium'>${k}</span>: ${JSON.stringify(getField(d,k))}</p>`).join('')}</div></div></div>`;$('#close-det').onclick=$('#det-bg').onclick=e=>{if(e.target.id==='det-bg'||e.target.id==='close-det')r.innerHTML=''};}

function openEditor(id){const cfg=cfgs[S.cat];const d=id?structuredClone(S.data.find(x=>x.id===id)):{id:crypto.randomUUID()};const newItem=!id;const spec={展示品:['あり','なし'],展示品有無:['あり','なし'],'ゼロエミ.有無':['あり','なし']};const extra={'ゼロエミ':{'新規値引き':'','買い替え値引き':'','15年買い替え値引き':''},'同メーカー割':{'2台':'','3台':'','4台':''}};if(newItem)Object.assign(d,extra[cfg.flag.split('.')[0]]?{[cfg.flag.split('.')[0]]:structuredClone(extra[cfg.flag.split('.')[0]])}:{}) ;const keys=getAllKeys([d]);const r=$('#root-modal');const rows=keys.map(k=>{const v=getField(d,k)||'';const isSel=spec[k]!==undefined;const selOpt=isSel?spec[k].map(o=>`<option ${o===v?'selected':''}>${o}</option>`).join(''):'';return `<div><label class='text-xs font-medium'>${k}</label>${isSel?`<select class='border rounded w-full p-1 text-xs' name='${k}'>${selOpt}</select>`:"<input class='border rounded w-full p-1 text-xs' name='${k}' value='${v}'>"}</div>`}).join('');r.innerHTML=`<div class='fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50' id='edit-bg'><div class='bg-white rounded-xl w-full max-w-lg p-6 flex flex-col ani'><h3 class='text-xl font-bold mb-4'>${newItem?'新規':'編集'}</h3><form id='f-edit' class='grid grid-cols-2 gap-2 overflow-auto max-h-[65vh]'>${rows}</form><div class='flex justify-end gap-2 mt-4'><button class='btn btn-secondary' id='cancel'>キャンセル</button><button class='btn btn-primary' id='save'>保存</button></div></div></div>`;$('#cancel').onclick=$('#edit-bg').onclick=e=>{if(e.target.id==='edit-bg'||e.target.id==='cancel')r.innerHTML=''};$('#save').onclick=()=>{const fd=new FormData($('#f-edit'));keys.forEach(k=>{const v=fd.get(k);setField(d,k,v)});if(newItem)S.data.push(d);localStorage.setItem(cfg.file,JSON.stringify(S.data));r.innerHTML='';render();};}

function setField(o,k,v){if(k.includes('.')){const[a,b]=k.split('.');o[a]=o[a]||{};o[a][b]=v; }else o[k]=v;}
function getField(o,k){if(k.includes('.')){const[a,b]=k.split('.');return o[a]?.[b];}return o[k];}
function isFlag(o,c){return getField(o,c.flag)=='あり';}
async function askGemini(q){try{const res=await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${KEY}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({contents:[{role:'user',parts:[{text:q}]}]})});const j=await res.json();alert(j.candidates?.[0]?.content?.parts?.[0]?.text||'No response');}catch(e){alert('Gemini error:'+e);}}
</script>
</body>
</html>
