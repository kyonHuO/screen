<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>製品比較ツール</title>

  <!-- Tailwind CDN（開発時ならこれで OK。最終的には PurgeCSS で軽量化推奨） -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Markdownパーサ（Gemini の回答をレンダリングするとき用） -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* --- 必要最低限のカスタム CSS。詳細は前回と同じ --- */
    body { font-family: 'Noto Sans JP', sans-serif; background:#f8f9fa; }
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.08);transition:.3s;}
    .card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.1);}
    .btn{border-radius:8px;font-weight:500;transition:.2s;}
    .btn-primary{background:#3b82f6;color:#fff}.btn-primary:hover{background:#2563eb}
    .btn-secondary{background:#6b7280;color:#fff}.btn-secondary:hover{background:#4b5563}
    .btn-tertiary{background:#10b981;color:#fff}.btn-tertiary:hover{background:#059669}
    .btn-danger{background:#ef4444;color:#fff}.btn-danger:hover{background:#dc2626}
    ::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-thumb{background:#a8a8a8;border-radius:4px}
  </style>
</head>
<body class="antialiased text-gray-800">
  <!-- ========== ① 製品カテゴリ選択画面 ========== -->
  <div id="selection-screen" class="flex flex-col items-center justify-center min-h-screen p-6">
    <h1 class="text-4xl font-bold mb-6">製品比較ツール</h1>
    <p class="mb-10 text-gray-600">比較したい製品カテゴリを選んでください</p>
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 w-full max-w-4xl">
      <button id="select-tv" class="card p-8 text-center hover:shadow-lg">
        <div class="text-5xl mb-4">📺</div><span class="text-xl font-semibold">テレビ</span>
      </button>
      <button id="select-ac" class="card p-8 text-center hover:shadow-lg">
        <div class="text-5xl mb-4">💨</div><span class="text-xl font-semibold">エアコン</span>
      </button>
      <button id="select-refrigerator" class="card p-8 text-center hover:shadow-lg">
        <div class="text-5xl mb-4">🧊</div><span class="text-xl font-semibold">冷蔵庫</span>
      </button>
    </div>
  </div>

  <!-- ========== ② メインアプリ画面（初期は hidden） ========== -->
  <div id="app-container" class="hidden container mx-auto p-6">
    <!-- タイトル & 戻るボタン -->
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
      <button id="back-to-selection" class="btn bg-gray-200 text-gray-700 px-3 py-1">&larr; 戻る</button>
      <div>
        <h2 id="main-title" class="text-2xl font-bold"></h2>
        <p id="main-subtitle" class="text-gray-500"></p>
      </div>
    </header>

    <!-- フィルタ → モデル一覧 → 比較プレビュー（詳細は後述 JS が挿入） -->
    <div id="filter-container" class="space-y-6 mb-8"></div>
    <h3 id="model-list-title" class="text-xl font-bold mb-4"></h3>
    <div id="model-list" class="grid gap-6"></div>
    <div id="comparison-preview" class="my-8"></div>
  </div>

  <!-- ========== ③ 各種モーダル (詳細表示や比較表など) ========== -->
  <div id="modal-root"></div>

  <!-- ========== ④ メインスクリプト ========== -->
  <script>
    /* ----------------------------------------------------------------
       A. ここで「カテゴリごとの設定」と「JSONファイルの場所」を定義
    ---------------------------------------------------------------- */
    const productConfigs = {
      tv: {
        title: "テレビ型番比較ツール",
        subtitle: "気になるテレビを選択して性能を比較しましょう。",
        dataUrl: "tv-data.json",          // ← JSON ファイルへのパス
        modelNameKey: "モデル名",
        cardFields: [
          { label: "サイズ", key: "サイズ(インチ)", suffix: "インチ" },
          { label: "解像度", key: "解像度" },
          { label: "リフレッシュ", key: "リフレッシュレート" }
        ],
        filters: [
          { key: "メーカー", label: "メーカーで絞り込み" },
          { key: "ディスプレイ技術", label: "パネル種別" }
        ]
      },
      ac: {
        title: "エアコン型番比較ツール",
        subtitle: "気になるエアコンを選択して性能を比較しましょう。",
        dataUrl: "ac-data.json",
        modelNameKey: "型番",
        cardFields: [
          { label: "畳数", key: "畳数" },
          { label: "省エネ性能", key: "省エネ性能" },
          { label: "冷暖房能力", key: "冷暖房能力" }
        ],
        filters: [
          { key: "メーカー", label: "メーカーで絞り込み" },
          { key: "畳数", label: "適用畳数" }
        ]
      },
      refrigerator: {
        title: "冷蔵庫型番比較ツール",
        subtitle: "気になる冷蔵庫を選択して性能を比較しましょう。",
        dataUrl: "refrigerator-data.json",
        modelNameKey: "型番",
        cardFields: [
          { label: "容量", key: "定格内容積(L)", suffix: "L" },
          { label: "省エネ達成率", key: "省エネ基準達成率(%)", suffix: "%" },
          { label: "ドア", key: "ドアタイプ" }
        ],
        filters: [
          { key: "メーカー", label: "メーカーで絞り込み" },
          { key: "定格内容積(L)", label: "容量帯" }
        ]
      }
    };

    /* ----------------------------------------------------------------
       B. グローバル状態を持つシンプルなオブジェクト
    ---------------------------------------------------------------- */
    const appState = {
      productType: null,
      data: [],
      selected: [],
      filters: {}
    };

    /* ----------------------------------------------------------------
       C. ユーティリティ
    ---------------------------------------------------------------- */
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => document.querySelectorAll(sel);
    const sanitizeId = (str) => str.replace(/\s+/g,'_').replace(/[^\w-]/g,'');

    /* ----------------------------------------------------------------
       D. 画面遷移系
    ---------------------------------------------------------------- */
    function showSelection() {
      $("#selection-screen").classList.remove("hidden");
      $("#app-container").classList.add("hidden");
    }
    function showApp() {
      $("#selection-screen").classList.add("hidden");
      $("#app-container").classList.remove("hidden");
    }

    /* ----------------------------------------------------------------
       E. データ読み込み & レンダリング
    ---------------------------------------------------------------- */
    async function launchApp(type) {
      appState.productType = type;
      appState.selected = [];
      appState.filters = {};

      const cfg = productConfigs[type];
      $("#main-title").textContent = cfg.title;
      $("#main-subtitle").textContent = cfg.subtitle;

      // JSON を取得
      appState.data = await fetch(cfg.dataUrl).then(r => r.json());

      renderFilters();
      renderModelList();
      showApp();
    }

    function renderFilters() {
      const cfg = productConfigs[appState.productType];
      const container = $("#filter-container");
      container.innerHTML = "";
      cfg.filters.forEach(f => {
        const values = [...new Set(appState.data.map(d => d[f.key]).filter(Boolean))].sort();
        const section = document.createElement("div");
        section.innerHTML = `<h4 class="font-bold mb-2">${f.label}</h4>`;
        const btnWrap = document.createElement("div");
        btnWrap.className = "flex flex-wrap gap-2";
        // 「すべて」ボタン
        btnWrap.appendChild(makeFilterBtn(f.key, "すべて", null));
        values.forEach(v => btnWrap.appendChild(makeFilterBtn(f.key, v, v)));
        section.appendChild(btnWrap);
        container.appendChild(section);
      });
    }
    function makeFilterBtn(key, label, value) {
      const btn = document.createElement("button");
      btn.textContent = label;
      btn.className = "btn bg-gray-200 text-gray-700 px-3 py-1 text-sm";
      if (appState.filters[key] === value || (value===null && !(key in appState.filters))) {
        btn.classList.add("btn-primary","text-white");
      }
      btn.onclick = () => {
        if (value === null) delete appState.filters[key];
        else appState.filters[key] = value;
        renderFilters();
        renderModelList();
      };
      return btn;
    }

    function renderModelList() {
      const cfg = productConfigs[appState.productType];
      const wrap = $("#model-list");
      wrap.className = "grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6";
      let list = [...appState.data];

      // フィルタ適用
      Object.entries(appState.filters).forEach(([k,v]) => {
        list = list.filter(d => d[k] === v);
      });

      // カード生成
      wrap.innerHTML = list.map(item => {
        const selected = appState.selected.includes(item);
        return `
          <div class="card p-5 ${selected?'ring-2 ring-blue-400':''}" data-id="${sanitizeId(item[cfg.modelNameKey])}">
            <h3 class="text-lg font-bold mb-2">${item["メーカー"]} ${item[cfg.modelNameKey]}</h3>
            ${cfg.cardFields.map(f => `
              <p class="text-sm"><strong>${f.label}:</strong> ${item[f.key]||'—'}${f.suffix||''}</p>
            `).join("")}
            <button class="btn ${selected?'btn-secondary':'btn-primary'} text-xs px-3 py-1 mt-4 select-btn">
              ${selected?'選択解除':'選択'}
            </button>
          </div>`;
      }).join("");

      // ボタンにイベント付与
      $$("#model-list .select-btn").forEach(btn => {
        btn.onclick = (e) => {
          const card = e.target.closest(".card");
          const id = card.dataset.id;
          const model = list.find(d => sanitizeId(d[cfg.modelNameKey]) === id);
          const idx = appState.selected.indexOf(model);
          if (idx>-1) appState.selected.splice(idx,1); else appState.selected.push(model);
          renderModelList();
          renderComparisonPreview();
        };
      });
      renderComparisonPreview();
    }

    function renderComparisonPreview() {
      const wrap = $("#comparison-preview");
      const sel = appState.selected;
      if (!sel.length) { wrap.innerHTML = ""; return; }
      wrap.innerHTML = `
        <h4 class="font-bold mb-2">比較中 (${sel.length})</h4>
        <div class="flex flex-wrap gap-2 mb-3">
          ${sel.map(m => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${m["メーカー"]} ${m[productConfigs[appState.productType].modelNameKey]}</span>`).join("")}
        </div>
        <button class="btn btn-primary text-sm px-4 py-1" id="compare-btn">比較表を表示</button>
      `;
      $("#compare-btn")?.addEventListener("click", showComparisonModal);
    }

    function showComparisonModal() {
      const cfg = productConfigs[appState.productType];
      const sel = appState.selected;
      const headers = Object.keys(sel[0]);
      let html = `
        <div class="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50" id="cmp-modal">
          <div class="bg-white rounded-lg shadow-xl max-w-full max-h-full overflow-auto p-6">
            <button class="text-2xl mb-4" id="cmp-close">&times;</button>
            <table class="border-collapse text-sm">
              <thead><tr><th class="border p-2 bg-gray-100">項目</th>${sel.map(m=>`<th class="border p-2 bg-gray-100">${m["メーカー"]}<br>${m[cfg.modelNameKey]}</th>`).join("")}</tr></thead>
              <tbody>
              ${headers.filter(h=>h!=="id").map(h=>`
                <tr>
                  <td class="border p-2 font-bold bg-gray-50">${h}</td>
                  ${sel.map(m=>`<td class="border p-2">${m[h]||'—'}</td>`).join("")}
                </tr>
              `).join("")}
              </tbody>
            </table>
          </div>
        </div>`;
      $("#modal-root").innerHTML = html;
      $("#cmp-close").onclick = () => $("#cmp-modal").remove();
    }

    /* ----------------------------------------------------------------
       F. イベント登録
    ---------------------------------------------------------------- */
    $("#select-tv").onclick = () => launchApp("tv");
    $("#select-ac").onclick = () => launchApp("ac");
    $("#select-refrigerator").onclick = () => launchApp("refrigerator");
    $("#back-to-selection").onclick = showSelection;
  </script>
</body>
</html>
